# Τα λεωφορεία που συνεννοούνται για να κρατούν αποστάσεις

## Σχεδιασμός επικοινωνίας και λογισμικού

### Γενικά

Τα οχήματα κινούνται σε κυκλική τροχιά,
έχουν επιθυμητή ταχύτητα **GKAZI**
και *δεν* περνούν από τις στάσεις πριν τις προβλεπόμενες ώρες άφιξης.
Επίσης, το όχημα μπορεί επηρρεάζεται από την καθυστέρηση του προπορευόμενου οχήματος,
αλλά δεν επηρρεάζεται από τα οχήματα που το ακολουθούν.

Το όχημα μπορεί να πηγαίνει λίγο πιο γρήγορα ή αργά στη διαδρομή, ή να περιμένει παραπάνω στις στάσεις.

Η αρχική εκπαίδευση γίνεται με την επιθυμητή ταχύτητα.
Αν εντοπιστούν εμπόδια, αυτό σημειώνεται (**CLEAN** = *False*)
και η εκπαίδευση μπορεί να επαναληφθεί.

Τρίτο όχημα (μη προγραμματιζόμενο, με τηλεχειρισμό)
θα μπορεί να κινείται στην πίστα για να εξομοιώνει εμπόδια πάνω στη διαδρομή των προγραμματιζόμενων οχημάτων.

### Χειροκίνητη οδήγηση

Το όχημα θα μπορεί να παίρνει άμεσα εντολές οδήγησης με τηλεχειρισμό,
  * Για αλλαγή της ταχύτητάς του
  * Για αλλαγή της κατεύθυνσής του
ώστε να τροποποιούμε ή το επαναφέρουμε στην πορεία του,
και να διευκολύνουμε τις διορθώσεις στις δοκιμές.

### Τύποι στάσεων

  * μεγάλες
      * έχουν μεγαλύτερη διάρκεια
      * πραγματοποιούνται πάντα
  * μικρές
      * έχουν μικρότερη διάρκεια
      * πραγματοποιούνται με κάποια πιθανότητα
  * έκτακτες / αναγκαστικές

### Αναγνώριση στάσεων και εμποδίων

Η αναγνώριση στάσεων και αφετηρίας / τερματισμού
  * θα οριστοκοποιηθεί με την κατασκευή της πίστας
  * Κατά προτίμηση θα γίνεται με την ανίχνευση σταθερών χαρακτηριστικών πάνω στην πορεία
      * Πρόσθετες γραμμές, άλλου ή ίδιου χρώματος, πιθανώς κάθετες.
      * Εντοπισμός ειδικών σημάτων τύπου QR-code
      * Άλλα σημάδια, με αναγνώριση εικόνας κάμερας (π.χ. οδικά σήματα)
      * Αναγνωρίζοντας την παράκαμψη του οχήματος
  * Αλλά μπορεί να γίνει και με την αποστολή ειδικής εντολής στο όχημα.

Η αναγώριση εμποδίων θα γίνεται είτε
  * με αισθητήρα απόστασης
  * με τη χρήση κάμερας

Όταν στο όχημα υπάρχει κάμερα θα μπορεί να αναγνωρίζει:
  * Χαρακτηριστικά αντικείμενα πάνω στη διαδρομή
  * Παροδικά αντικείμενα που συναντά
  * Εμπόδια μπροστά από το όχημα που το αναγκάζουν να σταματήσει
  * Eιδικά σημάτων τύπου QR-code
      * για θέση και ονομασία στάσεων
      * για άλλες οδηγίες (όπως όρια ταχύτητας)

Άλλη αναγνώριση με τη χρήση κάμερας
  * Θα γίνουν δοκιμές για να φανεί τι άλλο μπορούμε να αναγνωρίσουμε
      * και πώς θα το αξιοποιήσουμε
  * μπορεί να εμφανίζει την αντίστοιχη πληροφορία και να την μεταδίδει

### Τύποι διαδρομών

Σε όλες τις διαδρομες το όχημα ακολουθεί τη γραμμή και αναγνωρίζει τις στάσεις.
  * Πρώτα θα υλοποιηθει η βασική αυτή διαδρομή, με μια μέση ταχύτητα.
  * Επίσης θα δοκιμαστεί ώστε να μην δυσκολεύεται με λίγο μεγαλύτερη ταχύτητα.
  * Ακολούθως το όχημα θα μεταδίδει την άφιξή του στις στάσεις
      * Το σταθμαρχείο θα λαμβάνει και μπορεί να εμφανίζει τη θέση του οχήματος

Μετά θα διαφοροποιηθεί ο τρόπος εκτέλεσης της διαδρομής ώστε να γίνουν οι παραλλαγές του:

 1. Διαδρομή με εμπόδια (όπως άλλα οχήματα)
      * Το όχημα κατά τη διαδρομή του θα σταματά και θα περιμένει να φύγουν τα εμπόδια
 2. Διαδρομή αρχικοποίησης
      * Το όχημα θα κινείται με σταθερή, κατά το δυνατόν, ταχύτητα, όπως σε μια ιδανική διαδρομή.
      * Κατά τη διαδρομή του θα καταγράφει το χρόνο άφιξης σε κάθε στάση, σε ένα πίνακα χρόνων στάσεων.
          * Ο πίνακας χρόνων στάσεων θα χρησιμοποιείται σε διαδρομές άλλων τύπων
          * Ο πίνακας χρόνων στάσεων θα μεταδίδεται και θα λαμβάνεται από το σταθμαρχείο και άλλα οχήματα
              * Ο πίνακας χρόνων στάσεων θα μπορεί να εμφανιστεί στην οθόνη του σταθμαρχείου
      * Δεν θα πρέπει να βρει εμπόδια, αλλά αν βρει:
          * θα σταματά και θα περιμένει να φύγουν τα εμπόδια
          * Θα ξεκινά την καταγραφή από την αρχή
 3. Διαδρομή με χρονικό στόχο
      * Είναι η κατάλληλη διαδρομή για το προπορευόμενο όχημα
      * Το όχημα θα κινείται με τέτοια ταχύτητα, ώστε να προσπαθεί να τηρήσει τον πίνακα χρόνων στάσεων
      * Αν δεν συναντήσει εμπόδια, φυσιολογικά θα κινείται με σταθερή ταχύτητα.
      * Αν συναντήσει εμπόδια, θα σταματά και θα περιμένει να φύγουν τα εμπόδια.
          * Ακολούθως θα προσαρμόζει την ταχύτητά του (μέσα στα όρια ταχύτητας που έχουν καθοριστεί) ώστε να προσπαθεί να τηρήσει τον πίνακα χρόνων στάσεων
 4. Διαδρομή σταθερής απόστασης από το προπορευόμενο όχημα
      * Το όχημα θα λαμβάνει τους χρόνους άφιξης στις στάσεις του προπορευόμενου οχήματος
      * Το όχημα θα κινείται με ταχύτητα που θα αναπροσαρμόζει ώστε να προσπαθεί να τηρήσει σταθερή απόσταση από το προπορευόμενο όχημα.
          * Η σταθερή απόσταση μπορεί να υπολογίζεται
              * είτε σε αριθμό ενδιάμεσων στάσεων
              * είτε σε χρόνο κάλυψης της ενδιάμεσης απόστασης (ειδικά αν δεν ισαπέχουν οι στάσεις).
      * Αν συναντήσει εμπόδια, θα σταματά και θα περιμένει να φύγουν τα εμπόδια.
          * Ακολούθως θα προσαρμόζει την ταχύτητά του ώστε να προσπαθεί να τηρήσει τη σταθερή απόσταση
      * To όχημα αναπροσαρμόζει την ταχύτητά του μέσα στα όρια ταχύτητας που έχουν καθοριστεί
          * Αν χρειάζεται μικρότερη ταχύτητα, θα καθυστερήσει στην επόμενη στάση.
     * Αν χρειάζεται μεγαλύτερη ταχύτητα, θα κινηθεί με τη μέγιστη επιτρεπόμενη.
              * και θα συνεχίζει να καλύπτει τη διαφορά μετά την επόμενη στάση.
 5. Διαδρομή έξυπνης απόστασης
      * Το προπορευόμενο όχημα κατά την πορεία μεταδίδει συνεχώς
          * Την άφιξή του στις στάσεις (όπως προηγουμένως) και επίσης
          * Την εκτιμώμενη θέση του ανά τακτικά χρονικά διαστήματα
              * Η εκτιμώμενη θέση του μπορεί να εκφράζεται ως εκτιμώμενο χρόνο διαδρομής από την τελευταία στάση του
              * Έτσι αν το όχημα έχει ακινητοποιηθεί από εμπόδια, θα εξακολουθεί να μεταδίδει τη θέση του.
   * Το όχημα θα λαμβάνει τα εκπεμπόμενα δεδομένα του προπορευόμενου οχήματος
              * και θα αναπροσαρμόζει την ταχύτητά του για σταθερή απόσταση από αυτό
              * Αν σταματήσει να λαμβάνει δεδομένα, θα υποθέσει βλάβη του προπορευόμενου οχήματος
                  * και θα μεταβεί σε λειτουργία *Διαδρομή με χρονικό στόχο*
                  * αλλά μπορεί να επανέλθει στην *έξυπνη διαδρομή* του αν επανέλθουν οι λήψεις.

  * Το προπορευόμενο όχημα μπορεί να μεταδώσει σήμα ότι *αποσύρρεται* οριστικά ώστε το επόμενο όχημα να αλλάξει τύπο διαδρομής σε  *Διαδρομή με χρονικό στόχο*.

### Σταθερές που επηρρεάζουν τη λειτουργία

  * **GKAZI** η επιθυμητή / ιδανική ταχύτητα κίνησης
  * **REALLY_STOP** στις στάσεις
  * **GKAZI_LESS**, **GKAZI_MORE**, πόσο επιτρέπεται να κινηθούμε πιο αργά ή πιο γρήγορα.
  * **LOOK_AHEAD** σε πόσες στάσεις σχεδιάζει να ρυθμίσει τη διαφορά από το προπορευόμενο όχημα
  * **RISKY** Πιο επιθετικός τρόπος ρύθμισης της διαφοράς από το προπορευόμενο όχημα

### Υπολογισμός ταχύτητας δεύτερου οχήματος:

Σε κάθε στάση επαναϋπολογίζει τους χρόνους
  * **delay** καθυστέρηση για να καλύψει
  * **dtime** o χρόνος κάλυψης των **LOOK_AHEAD** επόμενων στάσεων
  * **speed** = **GKAZI** αν **delay** == 0
  * **extraspeed** = **delay** / **dtime**
  * αν **extraspeed** > **GKAZI_MORE**: **extraspeed** = **GKAZI_MORE**
  * αν **extraspeed** < **GKAZI_LESS**: **extraspeed** = **GKAZI_LESS** και καθυστέρησε στη στάση

### Η διαδρομή και οι στάσεις

Η διαδρομή έκφράζεται με λίστες:
  * **staseis_times** ο χρόνος άφιξης σε κάθε στάση. Το μέγεθος της λίστας εκφράζει τον αριθμό των στάσεων. Η τελευταία στάση, ο τερματισμός, είναι και η αφετηρία.
  * **staseis_names** ονόματα για εμφάνιση
  * **staseis_types** 1: υποχρεωτική, 0: προαιρετική, -1: κατηργημένη/αδρανής

## Ασύρματη επικοινωνία

### Εντολές απευθείας στο όχημα:

  * Ορισμός ταυτότητας (1, 2, 3, ...)
  * Διαδρομή χαρτογράφησης (πίνακας χρόνων στάσεων)
  * Εμφάνιση χαρτογράφησης

### Μοντέλο

Κάθε όχημα έχει μια ταυτότητα, το πρώτο 1, το δεύτερο 2.
Το σταθμαρχείο έχει ταυτότητα 0 ή >200.

Τα μηνύματα στέλνονται σε όλους, αναφέροντας την ταυτότητα του αποστολέα.
Ο παραλήπτης κρίνει αν θα αξιοποιήσει το μήνυμα.

### Δεδομένα

Κάθε φορά στέλνουμε τη συνολική πληροφορία (π.χ. θέση οχήματος και σχετική καθυστέρηση από σταθερό σημείο)
και όχι το τελευταίο τμήμα της (π.χ. επιπλέον καθυστέρηση από την προηγούμενη φορά)
ώστε να μην μας επηρρεάζει πιθανή απώλεια μηνυμάτων.

Η θέση ενός οχήματος θα προσδιορίζεται με βάση τον κανονικό χρόνο (της διαδρομής εκμάθησης) του από την αφετηρία.

### Μορφή μηνυμάτων:

 1. ταυτότητα αποστολέα
 2. *κατηγορία* μηνύματος
      * 0 απλή πληροφόρηση που δεν χρειάζεται επεξεργασία
      * 1 αποστολή πληροφοριών κίνησης, για έμμεση εντολή
      * 2 εντολή για άμεση εκτέλεση
 3. Α/Α μηνύματος, για πιθανή επαναποστολή
 4. Δεδομένα, *ανά κατηγορία* μηνύματος
      * 0 απλή πληροφορία που δεν χρειάζεται επεξεργασία
          * Κείμενο για εμφάνιση στην οθόνη
      * 1 ενημέρωση πληροφοριών κίνησης, για έμμεση εντολή
          * είδος πληροφοριών κίνησης
              * 0 τακτική αναφορά εκτίμησης της θέσης
              * 1 χρόνος από την αφετηρία
              * 2 αριθμός στάσης / checkpoint
          * θέση οχήματος
          * πραγματικος χρόνος της διαδρομής του οχήματος από την αφετηρία
      * 2 εντολή για άμεση εκτέλεση
          * ταυτότητα αποδέκτη (255 για όλους)
          * εντολή
          * ποσότητα / παράμετρος

#### Εντολές οδήγησης μέσω μηνυμάτων

Παραδείγματα:
  * Στοπ - σταμάτα και μην ξεκινήσεις αυτόματα
  * Αύξηση ταχύτητας κατά 1%
  * Ελάττωση ταχύτητας κατά 1%
  * Χειροκίνητη οδήγηση: στροφή αριστερά
  * Χειροκίνητη οδήγηση: στροφή δεξιά
  * Χειροκίνητη οδήγηση: κίνηση μπροστά
  * Χειροκίνητη οδήγηση: κίνηση πίσω
  * Αλλαγή οδήγησης σε αυτόματη *τύπου*
  * Αλλαγή οδήγησης σε χειροκίνητη
  * Στάση μικρής διάρκειας
  * Στάση μεγάλης διάρκειας

Κωδικοποίηση
| Κωδικός | Χαρακτηριστικά | Παράμετροι |
| --- | --- | --- |
| 0x | χωρίς παράμετρο | - |
| 1x | χωρίς παράμετρο, με αντίστροφο | - |
| 2x | χωρίς παράμετρο, το αντίστροφο | - |
| 5x | με πλήθος παραμέτρων | πλήθος + ... |
| 6x | με 1 ακέραια παράμετρο / επιλογή | ακέραιος |
| 7x | με 1 δεκαδική παράμετρο | αριθμό |

| Κωδικός | Εντολή | Παράμετρος |
| --- | --- | --- |
|  0 | Στοπ - σταμάτα και μην ξεκινήσεις αυτόματα | - |
|  1 | Στάση μικρής διάρκειας | - |
|  2 | Στάση μεγάλης διάρκειας | - |
|  3 | Πήγαινε ως την αφετηρία και σταμάτησε | - |
| 11 | Αλλαγή ταχύτητας κατά 1% μπροστά | - |
| 12 | Χειροκίνητη οδήγηση: στροφή δεξιά | - |
| 21 | Αλλαγή ταχύτητας κατά 1% πίσω | - |
| 22 | Χειροκίνητη οδήγηση: στροφή αριστερά | - |
| 60 | Αλλαγή οδήγησης σε | 0: χειροκίνητη, 1..6: αυτόματη|
| 63 | Προχώρα στάσεις και σταμάτησε | αριθμός |
| 70 | Στάση συγκεκριμένης διάρκειας | διάρκεια |
| 71 | Χειροκίνητη οδήγηση: κίνηση μπροστά | ταχύτητα μπροστά |
| 72 | Χειροκίνητη οδήγηση: στροφή | ποσότητα δεξιά |

#### Εντολές διαχείρισης / εκπαίδευσης

| Κωδικός | Εντολή | Παράμετροι |
| --- | --- | --- |
| 40 | ping - έλεγχος επικοινωνίας | |
| 41 | pong - επιβεβαίωση επικοινωνίας | |
| 91 | Απομνημόνευση στάσης στην τρέχουσα θέση | 1: μικρή, 2: μεγάλη |
| 95 | Επανεκίνηση χαρτογράφησης | |
| 96 | Ολοκλήρωση χαρτογράφησης | |
| 97 | Εμφάνιση χαρτογράφησης | |
| 99 | Αποστολή / λήψη χαρτογράφησης | αριθμός χρόνων, ... |

## Άλλες ιδέες

  * Αυτόματος εντοπισμός του τέλους της διαδρομής.
  * Οδήγηση (επιλεγμένου οχήματος) μέσω εντολών του σταθμαρχείου.
  * Ανταλλαγή των αρχικών πληροφοριών διαδρομής - κοινή εικόνα τους.
  * Κυκλοφορία και άλλων οχημάτων στον ίδιο δρόμο, καθυστερώντας τα οχήματα.
  * Εκτίμηση ενδιάμεσων σημείων πάνω στη διαδρομή για ενημέρωση της καθυστέρησης.
